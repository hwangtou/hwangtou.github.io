<h1 id="安裝配置腳本草稿">安裝配置腳本（草稿）</h1>
<p>在研究nginx之前，我總是覺得configure和Makefile深不可測，自己的項目用得最多的就是CMake。而當我研究nginx之後，我發現configure也並不難，configure其實就是一個bash腳本。接下來讓以configure script作為入口，分析nginx的configure思路。</p>

<p>第1行代碼證明這是一個bash腳本，當我們在執行configure腳本時，shell會用/bin/sh程序來對configure文件進行解析。</p>

<p>第3、4行是版權信息，還有大神Igor Sysoev的“簽名”。</p>

<p>第7、8行的目的是去除shell中的本地化設置（所有LC_*設置值），讓命令能夠正確地運行。LC for Locale，LC_ALL是軟件在運行時的語言環境，包括語言（Language）、地域（Territory）和字符集（Code set）。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 1~12

<span class="c">#!/bin/sh</span>

<span class="c"># Copyright (C) Igor Sysoev</span>
<span class="c"># Copyright (C) Nginx, Inc.</span>


<span class="nv">LC_ALL</span><span class="o">=</span>C
<span class="nb">export </span>LC_ALL

. auto/options
. auto/init
. auto/sources

</code></pre>
</div>

<p>第10到12行執行auto目錄下的三個腳本：auto/options腳本，顧名思義，是用於處理configure命令的附加選項。在該腳本的6～166行，先是聲明了一系列的配置相關變量並賦予默認初值。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/options 6~166
<span class="nb">help</span><span class="o">=</span>no

<span class="nv">NGX_PREFIX</span><span class="o">=</span>
<span class="nv">NGX_SBIN_PATH</span><span class="o">=</span>
<span class="nv">NGX_MODULES_PATH</span><span class="o">=</span>
...

<span class="nv">NGX_CPU_CACHE_LINE</span><span class="o">=</span>
</code></pre>
</div>

<p>168～394行，這是一個用於處理configure所帶參數的for循環，語句</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/options 168~394

<span class="nv">NGX_POST_CONF_MSG</span><span class="o">=</span>

<span class="nv">opt</span><span class="o">=</span>

<span class="k">for </span>option
<span class="k">do
    </span><span class="nv">opt</span><span class="o">=</span><span class="s2">"</span><span class="nv">$opt</span><span class="s2"> </span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$option</span> | sed -e <span class="se">\"</span>s/<span class="se">\(</span>--[^<span class="o">=]</span><span class="k">*</span><span class="o">=</span><span class="se">\)\(</span>.<span class="k">*</span> .<span class="k">*</span><span class="se">\)</span>/<span class="se">\1</span><span class="s1">'\2'</span>/<span class="se">\"</span><span class="sb">`</span><span class="s2">"</span>

    <span class="k">case</span> <span class="s2">"</span><span class="nv">$option</span><span class="s2">"</span> <span class="k">in</span>
        -<span class="k">*</span><span class="o">=</span><span class="k">*</span><span class="p">)</span> <span class="nv">value</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$option</span><span class="s2">"</span> | sed -e <span class="s1">'s/[-_a-zA-Z0-9]*=//'</span><span class="sb">`</span> <span class="p">;;</span>
           <span class="k">*</span><span class="p">)</span> <span class="nv">value</span><span class="o">=</span><span class="s2">""</span> <span class="p">;;</span>
    <span class="k">esac</span>

    <span class="k">case</span> <span class="s2">"</span><span class="nv">$option</span><span class="s2">"</span> <span class="k">in</span>
        --help<span class="p">)</span>                          <span class="nb">help</span><span class="o">=</span>yes                   <span class="p">;;</span>

        --prefix<span class="o">=</span><span class="p">)</span>                       <span class="nv">NGX_PREFIX</span><span class="o">=</span><span class="s2">"!"</span>             <span class="p">;;</span>
        --prefix<span class="o">=</span><span class="k">*</span><span class="p">)</span>                      <span class="nv">NGX_PREFIX</span><span class="o">=</span><span class="s2">"</span><span class="nv">$value</span><span class="s2">"</span>        <span class="p">;;</span>
        --sbin-path<span class="o">=</span><span class="k">*</span><span class="p">)</span>
...

        --test-build-devpoll<span class="o">)</span>            <span class="nv">NGX_TEST_BUILD_DEVPOLL</span><span class="o">=</span>YES <span class="p">;;</span>
        --test-build-eventport<span class="p">)</span>          <span class="nv">NGX_TEST_BUILD_EVENTPORT</span><span class="o">=</span>YES <span class="p">;;</span>
        --test-build-epoll<span class="p">)</span>              <span class="nv">NGX_TEST_BUILD_EPOLL</span><span class="o">=</span>YES   <span class="p">;;</span>
        --test-build-solaris-sendfilev<span class="p">)</span>  <span class="nv">NGX_TEST_BUILD_SOLARIS_SENDFILEV</span><span class="o">=</span>YES <span class="p">;;</span>

        <span class="k">*</span><span class="p">)</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">: error: invalid option </span><span class="se">\"</span><span class="nv">$option</span><span class="se">\"</span><span class="s2">"</span>
            <span class="nb">exit </span>1
        <span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">done</span>
</code></pre>
</div>

<p>```bash 397~574
// auto/options</p>

<p>NGX_CONFIGURE=”$opt”</p>

<p>if [ $help = yes ]; then</p>

<p>cat « END</p>

<p>–help                             print this message</p>

<p>–prefix=PATH                      set installation prefix
  –sbin-path=PATH                   set nginx binary pathname
  –modules-path=PATH                set modules path
  –conf-path=PATH                   set nginx.conf pathname
  –error-log-path=PATH              set error log pathname
…</p>

<p>–with-openssl=DIR                 set path to OpenSSL library sources
  –with-openssl-opt=OPTIONS         set additional build options for OpenSSL</p>

<p>–with-debug                       enable debug logging</p>

<p>END</p>

<div class="highlighter-rouge"><pre class="highlight"><code>exit 1 fi ```
</code></pre>
</div>

<p>餘下的代碼大概是HTTP功能開關的設置，是否為Win32平台編譯的設置，和nginx目錄文件配置。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="o">[</span> <span class="nv">$HTTP</span> <span class="o">=</span> NO <span class="o">]</span>; <span class="k">then
    </span><span class="nv">HTTP_CHARSET</span><span class="o">=</span>NO
    <span class="nv">HTTP_GZIP</span><span class="o">=</span>NO
    <span class="nv">HTTP_SSI</span><span class="o">=</span>NO
    <span class="nv">HTTP_USERID</span><span class="o">=</span>NO
    <span class="nv">HTTP_ACCESS</span><span class="o">=</span>NO
    <span class="nv">HTTP_STATUS</span><span class="o">=</span>NO
    <span class="nv">HTTP_REWRITE</span><span class="o">=</span>NO
    <span class="nv">HTTP_PROXY</span><span class="o">=</span>NO
    <span class="nv">HTTP_FASTCGI</span><span class="o">=</span>NO
<span class="k">fi


if</span> <span class="o">[</span> <span class="s2">".</span><span class="nv">$NGX_PLATFORM</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">".win32"</span> <span class="o">]</span>; <span class="k">then
    </span><span class="nv">NGX_WINE</span><span class="o">=</span><span class="nv">$WINE</span>
<span class="k">fi


</span><span class="nv">NGX_SBIN_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_SBIN_PATH</span><span class="k">:-</span><span class="nv">sbin</span><span class="p">/nginx</span><span class="k">}</span>
<span class="nv">NGX_MODULES_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_MODULES_PATH</span><span class="k">:-</span><span class="nv">modules</span><span class="k">}</span>
<span class="nv">NGX_CONF_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_CONF_PATH</span><span class="k">:-</span><span class="nv">conf</span><span class="p">/nginx.conf</span><span class="k">}</span>
<span class="nv">NGX_CONF_PREFIX</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$NGX_CONF_PATH</span><span class="sb">`</span>
<span class="nv">NGX_PID_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_PID_PATH</span><span class="k">:-</span><span class="nv">logs</span><span class="p">/nginx.pid</span><span class="k">}</span>
<span class="nv">NGX_LOCK_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_LOCK_PATH</span><span class="k">:-</span><span class="nv">logs</span><span class="p">/nginx.lock</span><span class="k">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">".</span><span class="nv">$NGX_ERROR_LOG_PATH</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">".stderr"</span> <span class="o">]</span>; <span class="k">then
    </span><span class="nv">NGX_ERROR_LOG_PATH</span><span class="o">=</span>
<span class="k">else
    </span><span class="nv">NGX_ERROR_LOG_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_ERROR_LOG_PATH</span><span class="k">:-</span><span class="nv">logs</span><span class="p">/error.log</span><span class="k">}</span>
<span class="k">fi

</span><span class="nv">NGX_HTTP_LOG_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_HTTP_LOG_PATH</span><span class="k">:-</span><span class="nv">logs</span><span class="p">/access.log</span><span class="k">}</span>
<span class="nv">NGX_HTTP_CLIENT_TEMP_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_HTTP_CLIENT_TEMP_PATH</span><span class="k">:-</span><span class="nv">client_body_temp</span><span class="k">}</span>
<span class="nv">NGX_HTTP_PROXY_TEMP_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_HTTP_PROXY_TEMP_PATH</span><span class="k">:-</span><span class="nv">proxy_temp</span><span class="k">}</span>
<span class="nv">NGX_HTTP_FASTCGI_TEMP_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_HTTP_FASTCGI_TEMP_PATH</span><span class="k">:-</span><span class="nv">fastcgi_temp</span><span class="k">}</span>
<span class="nv">NGX_HTTP_UWSGI_TEMP_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_HTTP_UWSGI_TEMP_PATH</span><span class="k">:-</span><span class="nv">uwsgi_temp</span><span class="k">}</span>
<span class="nv">NGX_HTTP_SCGI_TEMP_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_HTTP_SCGI_TEMP_PATH</span><span class="k">:-</span><span class="nv">scgi_temp</span><span class="k">}</span>

<span class="k">case</span> <span class="s2">".</span><span class="nv">$NGX_PERL_MODULES</span><span class="s2">"</span> <span class="k">in</span>
    ./<span class="k">*</span><span class="p">)</span>
    <span class="p">;;</span>

    .<span class="p">)</span>
    <span class="p">;;</span>

    <span class="k">*</span><span class="p">)</span>
        <span class="nv">NGX_PERL_MODULES</span><span class="o">=</span><span class="nv">$NGX_PREFIX</span>/<span class="nv">$NGX_PERL_MODULES</span>
    <span class="p">;;</span>
<span class="k">esac</span>
</code></pre>
</div>

<p>auto/init腳本，定義了Makefile文件路徑變量（NGX_MAKEFILE）、nginx模塊選項源文件路徑變量（NX_MODULE_S_C）、configure腳本生成的項目頭文件路徑變量（NGX_AUTO_HEADERS_H、NGX_AUTO_CONFIG_H）、自動測試文件路徑變量（NGX_AUTOTEST）、自動配置錯誤文件路徑變量（NGX_AUTOCONF_ERR），以及Makefile文件路徑變量（MAKEFILE）。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/init 6~21

<span class="nv">NGX_MAKEFILE</span><span class="o">=</span><span class="nv">$NGX_OBJS</span>/Makefile
<span class="nv">NGX_MODULES_C</span><span class="o">=</span><span class="nv">$NGX_OBJS</span>/ngx_modules.c

<span class="nv">NGX_AUTO_HEADERS_H</span><span class="o">=</span><span class="nv">$NGX_OBJS</span>/ngx_auto_headers.h
<span class="nv">NGX_AUTO_CONFIG_H</span><span class="o">=</span><span class="nv">$NGX_OBJS</span>/ngx_auto_config.h

<span class="nv">NGX_AUTOTEST</span><span class="o">=</span><span class="nv">$NGX_OBJS</span>/autotest
<span class="nv">NGX_AUTOCONF_ERR</span><span class="o">=</span><span class="nv">$NGX_OBJS</span>/autoconf.err

<span class="c"># STUBs</span>
<span class="nv">NGX_ERR</span><span class="o">=</span><span class="nv">$NGX_OBJS</span>/autoconf.err
<span class="nv">MAKEFILE</span><span class="o">=</span><span class="nv">$NGX_OBJS</span>/Makefile


<span class="nv">NGX_PCH</span><span class="o">=</span>
<span class="nv">NGX_USE_PCH</span><span class="o">=</span>
</code></pre>
</div>

<p>測試當前環境shell顯示字符串-n和\c的能力，因為不同系統的shell對此存在兼容性差別。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/init 24~40

<span class="c"># check the echo's "-n" option and "\c" capability</span>

<span class="k">if </span><span class="nb">echo</span> <span class="s2">"test</span><span class="se">\c</span><span class="s2">"</span> | grep c &gt;/dev/null; <span class="k">then

    if </span><span class="nb">echo</span> -n <span class="nb">test</span> | grep n &gt;/dev/null; <span class="k">then
        </span><span class="nv">ngx_n</span><span class="o">=</span>
        <span class="nv">ngx_c</span><span class="o">=</span>

    <span class="k">else
        </span><span class="nv">ngx_n</span><span class="o">=</span>-n
        <span class="nv">ngx_c</span><span class="o">=</span>
    <span class="k">fi

else
    </span><span class="nv">ngx_n</span><span class="o">=</span>
    <span class="nv">ngx_c</span><span class="o">=</span><span class="s1">'\c'</span>
<span class="k">fi</span>
</code></pre>
</div>

<p>最後，創建Makefile文件，定義make指令和make clean指令的行為。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/init 43~51

<span class="c"># create Makefile</span>

cat <span class="sh">&lt;&lt; END &gt; Makefile

default:	build

clean:
	rm -rf Makefile $NGX_OBJS
END
</span></code></pre>
</div>

<p>auto/sources，定義core模塊、event模塊等模塊的INCS（include path頭文件搜索路徑）、DEPS（depend headers依賴頭文件列表）、SRCS（source files源文件列表）等變量；以及UNIX、FREEBSD、LINUX等不同操作系統的INCS、DEPS、SRCS變量。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/sources 6~44

<span class="nv">CORE_MODULES</span><span class="o">=</span><span class="s2">"ngx_core_module ngx_errlog_module ngx_conf_module"</span>

<span class="nv">CORE_INCS</span><span class="o">=</span><span class="s2">"src/core"</span>

<span class="nv">CORE_DEPS</span><span class="o">=</span><span class="s2">"src/core/nginx.h </span><span class="se">\</span><span class="s2">
           src/core/ngx_config.h </span><span class="se">\</span><span class="s2">
           src/core/ngx_core.h </span><span class="se">\</span><span class="s2">
           src/core/ngx_log.h </span><span class="se">\</span><span class="s2">
           src/core/ngx_palloc.h </span><span class="se">\</span><span class="s2">
...
           src/core/ngx_syslog.h"</span>
</code></pre>
</div>

<p>回到configure文件，第14行，測試objs目錄是否存在，若不存在即創建objs目錄。第16～19行，在命令行上顯示之前配置好的參數。第22～24行，若為調試模式，則往objs/ngx_auto_config.h文件尾部加入NGX_DEBUG為1的宏定義。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 14~24

<span class="nb">test</span> -d <span class="nv">$NGX_OBJS</span> <span class="o">||</span> mkdir -p <span class="nv">$NGX_OBJS</span>

<span class="nb">echo</span> &gt; <span class="nv">$NGX_AUTO_HEADERS_H</span>
<span class="nb">echo</span> &gt; <span class="nv">$NGX_AUTOCONF_ERR</span>

<span class="nb">echo</span> <span class="s2">"#define NGX_CONFIGURE </span><span class="se">\"</span><span class="nv">$NGX_CONFIGURE</span><span class="se">\"</span><span class="s2">"</span> &gt; <span class="nv">$NGX_AUTO_CONFIG_H</span>


<span class="k">if</span> <span class="o">[</span> <span class="nv">$NGX_DEBUG</span> <span class="o">=</span> YES <span class="o">]</span>; <span class="k">then
    </span><span class="nv">have</span><span class="o">=</span>NGX_DEBUG . auto/have
<span class="k">fi</span>
</code></pre>
</div>

<p>第27到47行，如果NGX_PLATFORM未定義，則用uname命令獲取系統內核名稱、內核版本、機器架構信息（順帶一提，2&gt;/dev/null的意思是把輸出的stderr流拋棄，/dev/null也被稱為“黑洞”），若獲取到的系統內核名稱為“MINGW32”，則把系統名重命名為win32。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 27~47

<span class="k">if </span><span class="nb">test</span> -z <span class="s2">"</span><span class="nv">$NGX_PLATFORM</span><span class="s2">"</span>; <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"checking for OS"</span>

    <span class="nv">NGX_SYSTEM</span><span class="o">=</span><span class="sb">`</span>uname -s 2&gt;/dev/null<span class="sb">`</span>
    <span class="nv">NGX_RELEASE</span><span class="o">=</span><span class="sb">`</span>uname -r 2&gt;/dev/null<span class="sb">`</span>
    <span class="nv">NGX_MACHINE</span><span class="o">=</span><span class="sb">`</span>uname -m 2&gt;/dev/null<span class="sb">`</span>

    <span class="nb">echo</span> <span class="s2">" + </span><span class="nv">$NGX_SYSTEM</span><span class="s2"> </span><span class="nv">$NGX_RELEASE</span><span class="s2"> </span><span class="nv">$NGX_MACHINE</span><span class="s2">"</span>

    <span class="nv">NGX_PLATFORM</span><span class="o">=</span><span class="s2">"</span><span class="nv">$NGX_SYSTEM</span><span class="s2">:</span><span class="nv">$NGX_RELEASE</span><span class="s2">:</span><span class="nv">$NGX_MACHINE</span><span class="s2">"</span>;

    <span class="k">case</span> <span class="s2">"</span><span class="nv">$NGX_SYSTEM</span><span class="s2">"</span> <span class="k">in
        </span>MINGW32_<span class="k">*</span><span class="p">)</span>
            <span class="nv">NGX_PLATFORM</span><span class="o">=</span>win32
        <span class="p">;;</span>
    <span class="k">esac</span>

<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"building for </span><span class="nv">$NGX_PLATFORM</span><span class="s2">"</span>
    <span class="nv">NGX_SYSTEM</span><span class="o">=</span><span class="nv">$NGX_PLATFORM</span>
<span class="k">fi</span>
</code></pre>
</div>

<p>第49行執行auto/cc/conf腳本，auto/cc目錄顧名思義就是C編譯器（c compiler）相關配置的目錄。conf腳本為主腳本，定義編譯器相關的變量，然後根據不同的編譯器調用不同的腳本；name腳本用於獲取編譯器名稱；auto/cc目錄下的其它腳本主要用於特定編譯器的配置。</p>

<p>auto/cc/conf腳本，對編譯器的相關變量進行聲明，再執行auto/cc/name腳本，通過判斷目前平台變量（$NGX_PLATFORM）和編譯器類型變量（$CC）來對相關變量和$NGX_CC_NAME進行初始化，並打印當前使用的編譯器信息“using xxx C Compiler”。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 49

. auto/cc/conf
</code></pre>
</div>

<p>第51到53行，如果NGX_PLATFORM不是定義為win32的平台，則執行auto/header腳本，而這個腳本則通過調用auto/include腳本來檢測unistd.h等腳本在該平台下的可運行性。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 51~53

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$NGX_PLATFORM</span><span class="s2">"</span> !<span class="o">=</span> win32 <span class="o">]</span>; <span class="k">then</span>
    . auto/headers
<span class="k">fi</span>
</code></pre>
</div>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/headers 6~13
<span class="nv">ngx_include</span><span class="o">=</span><span class="s2">"unistd.h"</span>;      . auto/include
<span class="nv">ngx_include</span><span class="o">=</span><span class="s2">"inttypes.h"</span>;    . auto/include
<span class="nv">ngx_include</span><span class="o">=</span><span class="s2">"limits.h"</span>;      . auto/include
<span class="nv">ngx_include</span><span class="o">=</span><span class="s2">"sys/filio.h"</span>;   . auto/include
<span class="nv">ngx_include</span><span class="o">=</span><span class="s2">"sys/param.h"</span>;   . auto/include
<span class="nv">ngx_include</span><span class="o">=</span><span class="s2">"sys/mount.h"</span>;   . auto/include
<span class="nv">ngx_include</span><span class="o">=</span><span class="s2">"sys/statvfs.h"</span>; . auto/include
<span class="nv">ngx_include</span><span class="o">=</span><span class="s2">"crypt.h"</span>;       . auto/include
</code></pre>
</div>

<p>auto/include會為傳入的ngx_include參數生成錯誤紀錄文件和自動測試文件，該測試文件實現簡單的引入頭文件功能並帶有一個main函數，然後用編譯器編譯該自動測試文件，並把編譯命令輸出的結果的錯誤信息重定向輸出到錯誤紀錄文件當中。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/include 6~58

<span class="nb">echo</span> <span class="nv">$ngx_n</span> <span class="s2">"checking for </span><span class="nv">$ngx_include</span><span class="s2"> ...</span><span class="nv">$ngx_c</span><span class="s2">"</span>

cat <span class="sh">&lt;&lt; END &gt;&gt; $NGX_AUTOCONF_ERR

----------------------------------------
checking for $ngx_include

END


</span><span class="nv">ngx_found</span><span class="o">=</span>no

cat <span class="sh">&lt;&lt; END &gt; $NGX_AUTOTEST.c

$NGX_INCLUDE_SYS_PARAM_H
#include &lt;$ngx_include&gt;

int main(void) {
    return 0;
}

END


</span><span class="nv">ngx_test</span><span class="o">=</span><span class="s2">"</span><span class="nv">$CC</span><span class="s2"> -o </span><span class="nv">$NGX_AUTOTEST</span><span class="s2"> </span><span class="nv">$NGX_AUTOTEST</span><span class="s2">.c"</span>

<span class="nb">eval</span> <span class="s2">"</span><span class="nv">$ngx_test</span><span class="s2"> &gt;&gt; </span><span class="nv">$NGX_AUTOCONF_ERR</span><span class="s2"> 2&gt;&amp;1"</span>

<span class="k">if</span> <span class="o">[</span> -x <span class="nv">$NGX_AUTOTEST</span> <span class="o">]</span>; <span class="k">then

    </span><span class="nv">ngx_found</span><span class="o">=</span>yes

    <span class="nb">echo</span> <span class="s2">" found"</span>

    <span class="nv">ngx_name</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$ngx_include</span> <span class="se">\</span>
              | tr abcdefghijklmnopqrstuvwxyz/. ABCDEFGHIJKLMNOPQRSTUVWXYZ__<span class="sb">`</span>


    <span class="nv">have</span><span class="o">=</span>NGX_HAVE_<span class="nv">$ngx_name</span> . auto/have_headers

    <span class="nb">eval</span> <span class="s2">"NGX_INCLUDE_</span><span class="nv">$ngx_name</span><span class="s2">='#include &lt;</span><span class="nv">$ngx_include</span><span class="s2">&gt;'"</span>

<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">" not found"</span>

    <span class="nb">echo</span> <span class="s2">"----------"</span>    &gt;&gt; <span class="nv">$NGX_AUTOCONF_ERR</span>
    cat <span class="nv">$NGX_AUTOTEST</span>.c  &gt;&gt; <span class="nv">$NGX_AUTOCONF_ERR</span>
    <span class="nb">echo</span> <span class="s2">"----------"</span>    &gt;&gt; <span class="nv">$NGX_AUTOCONF_ERR</span>
    <span class="nb">echo</span> <span class="nv">$ngx_test</span>       &gt;&gt; <span class="nv">$NGX_AUTOCONF_ERR</span>
    <span class="nb">echo</span> <span class="s2">"----------"</span>    &gt;&gt; <span class="nv">$NGX_AUTOCONF_ERR</span>
<span class="k">fi

</span>rm -rf <span class="nv">$NGX_AUTOTEST</span><span class="k">*</span>
</code></pre>
</div>

<p>接下來用if [ -x ]來判斷編譯輸出的自動測試可執行文件是否存在且為可執行文件，若是，則表明找到了需要引入的頭文件，執行auto/have_headers腳本把其加入到$NGX_AUTO_HEADERS_H頭文件中，而這個文件則是objs/ngx_auto_config.h文件；否則，記錄到錯誤文件中。最後，清理自動測試相關的所有臨時文件。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/have_headers 6~12

cat <span class="sh">&lt;&lt; END &gt;&gt; $NGX_AUTO_HEADERS_H

#ifndef $have
#define $have  1
#endif

END
</span></code></pre>
</div>

<p>回到configure script，第55行，執行auto/os/conf腳本，該腳本用於初始化不同系統的特性變量，如圖，根據NGX_PLATFORM，執行不同系統的腳本，該特定腳本會檢測當前操作系統環境的相關特性是否可行，然後auto/have腳本把可用的特性加入到objs/ngx_auto_config.h文件中。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 55

. auto/os/conf
</code></pre>
</div>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/os/conf 6~78

<span class="nb">echo</span> <span class="s2">"checking for </span><span class="nv">$NGX_SYSTEM</span><span class="s2"> specific features"</span>

<span class="k">case</span> <span class="s2">"</span><span class="nv">$NGX_PLATFORM</span><span class="s2">"</span> <span class="k">in

    </span>FreeBSD:<span class="k">*</span><span class="p">)</span>
        . auto/os/freebsd
    <span class="p">;;</span>

...

    GNU:<span class="k">*</span><span class="p">)</span>
        <span class="c"># GNU Hurd</span>
        <span class="nv">have</span><span class="o">=</span>NGX_GNU_HURD . auto/have_headers
        <span class="nv">CORE_INCS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$UNIX_INCS</span><span class="s2">"</span>
        <span class="nv">CORE_DEPS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$UNIX_DEPS</span><span class="s2"> </span><span class="nv">$POSIX_DEPS</span><span class="s2">"</span>
        <span class="nv">CORE_SRCS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$UNIX_SRCS</span><span class="s2">"</span>
        <span class="nv">CC_AUX_FLAGS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$CC_AUX_FLAGS</span><span class="s2"> -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64"</span>
    <span class="p">;;</span>

    <span class="k">*</span><span class="p">)</span>
        <span class="nv">CORE_INCS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$UNIX_INCS</span><span class="s2">"</span>
        <span class="nv">CORE_DEPS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$UNIX_DEPS</span><span class="s2"> </span><span class="nv">$POSIX_DEPS</span><span class="s2">"</span>
        <span class="nv">CORE_SRCS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$UNIX_SRCS</span><span class="s2">"</span>
    <span class="p">;;</span>

<span class="k">esac</span>
</code></pre>
</div>

<p>另外，除了系統平台特徵的變量初始化，該腳本還會檢測當前CPU架構的Cache Line和內存對齊特性。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/os/conf 81~116
<span class="k">case</span> <span class="s2">"</span><span class="nv">$NGX_MACHINE</span><span class="s2">"</span> <span class="k">in

    </span>i386 <span class="p">|</span> i686 <span class="p">|</span> i86pc<span class="p">)</span>
        <span class="nv">have</span><span class="o">=</span>NGX_HAVE_NONALIGNED . auto/have
        <span class="nv">NGX_MACH_CACHE_LINE</span><span class="o">=</span>32
    <span class="p">;;</span>

...

    <span class="k">*</span><span class="p">)</span>
        <span class="nv">have</span><span class="o">=</span>NGX_ALIGNMENT <span class="nv">value</span><span class="o">=</span>16 . auto/define
        <span class="nv">NGX_MACH_CACHE_LINE</span><span class="o">=</span>32
    <span class="p">;;</span>

<span class="k">esac</span>

<span class="k">if </span><span class="nb">test</span> -z <span class="s2">"</span><span class="nv">$NGX_CPU_CACHE_LINE</span><span class="s2">"</span>; <span class="k">then
    </span><span class="nv">NGX_CPU_CACHE_LINE</span><span class="o">=</span><span class="nv">$NGX_MACH_CACHE_LINE</span>
<span class="k">fi

</span><span class="nv">have</span><span class="o">=</span>NGX_CPU_CACHE_LINE <span class="nv">value</span><span class="o">=</span><span class="nv">$NGX_CPU_CACHE_LINE</span> . auto/define
</code></pre>
</div>

<p>回到configure script，第57～59行，若非win32平台，則執行auto/unix腳本，該腳本首先分析了當前unix環境下的用戶和分組，並賦值給變量。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 57~59

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$NGX_PLATFORM</span><span class="s2">"</span> !<span class="o">=</span> win32 <span class="o">]</span>; <span class="k">then</span>
    . auto/unix
<span class="k">fi</span>
</code></pre>
</div>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/unix 6~27

<span class="nv">NGX_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_USER</span><span class="k">:-</span><span class="nv">nobody</span><span class="k">}</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">"</span><span class="nv">$NGX_GROUP</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">then
    if</span> <span class="o">[</span> <span class="nv">$NGX_USER</span> <span class="o">=</span> nobody <span class="o">]</span>; <span class="k">then
        if </span>grep nobody /etc/group 2&gt;&amp;1 &gt;/dev/null; <span class="k">then
            </span><span class="nb">echo</span> <span class="s2">"checking for nobody group ... found"</span>
            <span class="nv">NGX_GROUP</span><span class="o">=</span>nobody
        <span class="k">else
            </span><span class="nb">echo</span> <span class="s2">"checking for nobody group ... not found"</span>

            <span class="k">if </span>grep nogroup /etc/group 2&gt;&amp;1 &gt;/dev/null; <span class="k">then
                </span><span class="nb">echo</span> <span class="s2">"checking for nogroup group ... found"</span>
                <span class="nv">NGX_GROUP</span><span class="o">=</span>nogroup
            <span class="k">else
                </span><span class="nb">echo</span> <span class="s2">"checking for nogroup group ... not found"</span>
                <span class="nv">NGX_GROUP</span><span class="o">=</span>nobody
            <span class="k">fi
        fi
    else
        </span><span class="nv">NGX_GROUP</span><span class="o">=</span><span class="nv">$NGX_USER</span>
    <span class="k">fi
fi</span>
</code></pre>
</div>

<p>接下來便是對當前操作系統的unix特徵的一系列的分析，如圖，先賦值給如下變量，然後調用auto/feature腳本，該腳本和上面分析的auto/include腳本同理，通過生成自動測試代碼並編譯之來檢測當前系統是否支持該特性，如果支持，則加入到objs/ngx_auto_config.h文件中，否則則寫入錯誤記錄中。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/unix 30~46

<span class="nv">ngx_feature</span><span class="o">=</span><span class="s2">"poll()"</span>
<span class="nv">ngx_feature_name</span><span class="o">=</span>
<span class="nv">ngx_feature_run</span><span class="o">=</span>no
<span class="nv">ngx_feature_incs</span><span class="o">=</span><span class="s2">"#include &lt;poll.h&gt;"</span>
<span class="nv">ngx_feature_path</span><span class="o">=</span>
<span class="nv">ngx_feature_libs</span><span class="o">=</span>
<span class="nv">ngx_feature_test</span><span class="o">=</span><span class="s2">"int  n; struct pollfd  pl;
                  pl.fd = 0;
                  pl.events = 0;
                  pl.revents = 0;
                  n = poll(&amp;pl, 1, 0);
                  if (n == -1) return 1"</span>
. auto/feature

<span class="k">if</span> <span class="o">[</span> <span class="nv">$ngx_found</span> <span class="o">=</span> no <span class="o">]</span>; <span class="k">then
    </span><span class="nv">EVENT_POLL</span><span class="o">=</span>NONE
<span class="k">fi</span>
</code></pre>
</div>

<p>configure script第61行，執行auto/threads腳本，檢測當前環境對多線程的支持。第62行，執行auto/modules腳本，配置nginx模塊相關的變量並檢測模塊可用性。第63行，執行auto/lib/conf腳本，根據選項配置第三方庫如OpenSSL和zlib等。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 61~63

. auto/threads
. auto/modules
. auto/lib/conf
</code></pre>
</div>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/threads 5~20

<span class="k">if</span> <span class="o">[</span> <span class="nv">$USE_THREADS</span> <span class="o">=</span> YES <span class="o">]</span>; <span class="k">then

    if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$NGX_PLATFORM</span><span class="s2">"</span> <span class="o">=</span> win32 <span class="o">]</span>; <span class="k">then
        </span>cat <span class="sh">&lt;&lt; END

$0: --with-threads is not supported on Windows

END
</span>        <span class="nb">exit </span>1
    <span class="k">fi

    </span><span class="nv">have</span><span class="o">=</span>NGX_THREADS . auto/have
    <span class="nv">CORE_DEPS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$CORE_DEPS</span><span class="s2"> </span><span class="nv">$THREAD_POOL_DEPS</span><span class="s2">"</span>
    <span class="nv">CORE_SRCS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$CORE_SRCS</span><span class="s2"> </span><span class="nv">$THREAD_POOL_SRCS</span><span class="s2">"</span>
    <span class="nv">CORE_LIBS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$CORE_LIBS</span><span class="s2"> -lpthread"</span>
<span class="k">fi</span>
</code></pre>
</div>

<p>第65～100行，根據目前環境變量中的變量，調用auto/define腳本，把相關變量加入到objs/ngx_auto_config.h文件中。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 65~100

<span class="k">case</span> <span class="s2">".</span><span class="nv">$NGX_PREFIX</span><span class="s2">"</span> <span class="k">in</span>
    .<span class="p">)</span>
        <span class="nv">NGX_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">NGX_PREFIX</span><span class="k">:-</span><span class="p">/usr/local/nginx</span><span class="k">}</span>
        <span class="nv">have</span><span class="o">=</span>NGX_PREFIX <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_PREFIX</span><span class="s2">/</span><span class="se">\"</span><span class="s2">"</span> . auto/define
    <span class="p">;;</span>

    .!<span class="p">)</span>
        <span class="nv">NGX_PREFIX</span><span class="o">=</span>
    <span class="p">;;</span>

    <span class="k">*</span><span class="p">)</span>
        <span class="nv">have</span><span class="o">=</span>NGX_PREFIX <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_PREFIX</span><span class="s2">/</span><span class="se">\"</span><span class="s2">"</span> . auto/define
    <span class="p">;;</span>
<span class="k">esac</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">".</span><span class="nv">$NGX_CONF_PREFIX</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"."</span> <span class="o">]</span>; <span class="k">then
    </span><span class="nv">have</span><span class="o">=</span>NGX_CONF_PREFIX <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_CONF_PREFIX</span><span class="s2">/</span><span class="se">\"</span><span class="s2">"</span> . auto/define
<span class="k">fi

</span><span class="nv">have</span><span class="o">=</span>NGX_SBIN_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_SBIN_PATH</span><span class="se">\"</span><span class="s2">"</span> . auto/define
<span class="nv">have</span><span class="o">=</span>NGX_CONF_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_CONF_PATH</span><span class="se">\"</span><span class="s2">"</span> . auto/define
<span class="nv">have</span><span class="o">=</span>NGX_PID_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_PID_PATH</span><span class="se">\"</span><span class="s2">"</span> . auto/define
<span class="nv">have</span><span class="o">=</span>NGX_LOCK_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_LOCK_PATH</span><span class="se">\"</span><span class="s2">"</span> . auto/define
<span class="nv">have</span><span class="o">=</span>NGX_ERROR_LOG_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_ERROR_LOG_PATH</span><span class="se">\"</span><span class="s2">"</span> . auto/define

<span class="nv">have</span><span class="o">=</span>NGX_HTTP_LOG_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_HTTP_LOG_PATH</span><span class="se">\"</span><span class="s2">"</span> . auto/define
<span class="nv">have</span><span class="o">=</span>NGX_HTTP_CLIENT_TEMP_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_HTTP_CLIENT_TEMP_PATH</span><span class="se">\"</span><span class="s2">"</span>
. auto/define
<span class="nv">have</span><span class="o">=</span>NGX_HTTP_PROXY_TEMP_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_HTTP_PROXY_TEMP_PATH</span><span class="se">\"</span><span class="s2">"</span>
. auto/define
<span class="nv">have</span><span class="o">=</span>NGX_HTTP_FASTCGI_TEMP_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_HTTP_FASTCGI_TEMP_PATH</span><span class="se">\"</span><span class="s2">"</span>
. auto/define
<span class="nv">have</span><span class="o">=</span>NGX_HTTP_UWSGI_TEMP_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_HTTP_UWSGI_TEMP_PATH</span><span class="se">\"</span><span class="s2">"</span>
. auto/define
<span class="nv">have</span><span class="o">=</span>NGX_HTTP_SCGI_TEMP_PATH <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_HTTP_SCGI_TEMP_PATH</span><span class="se">\"</span><span class="s2">"</span>
. auto/define
</code></pre>
</div>

<p>第102～104行，auto/make腳本為生成Makefile文件的腳本，auto/lib/make為生成第三方庫Makefile文件的腳本，auto/install腳本生成Makefile文件中的install指令相關的操作。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 102~104

. auto/make
. auto/lib/make
. auto/install
</code></pre>
</div>

<p>而在configure script最後，第116行，打印configure的狀態概況。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// configure 106~116

<span class="c"># STUB</span>
. auto/stubs

<span class="nv">have</span><span class="o">=</span>NGX_USER <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_USER</span><span class="se">\"</span><span class="s2">"</span> . auto/define
<span class="nv">have</span><span class="o">=</span>NGX_GROUP <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_GROUP</span><span class="se">\"</span><span class="s2">"</span> . auto/define

<span class="k">if</span> <span class="o">[</span> <span class="s2">".</span><span class="nv">$NGX_BUILD</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"."</span> <span class="o">]</span>; <span class="k">then
    </span><span class="nv">have</span><span class="o">=</span>NGX_BUILD <span class="nv">value</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$NGX_BUILD</span><span class="se">\"</span><span class="s2">"</span> . auto/define
<span class="k">fi</span>

. auto/summary
</code></pre>
</div>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>// auto/summary 6~82

<span class="nb">echo
echo</span> <span class="s2">"Configuration summary"</span>


<span class="k">if</span> <span class="o">[</span> <span class="nv">$USE_THREADS</span> <span class="o">=</span> YES <span class="o">]</span>; <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"  + using threads"</span>
<span class="k">fi</span>

...

cat <span class="sh">&lt;&lt; END
  nginx path prefix: "$NGX_PREFIX"
  nginx binary file: "$NGX_SBIN_PATH"
  nginx modules path: "$NGX_MODULES_PATH"
  nginx configuration prefix: "$NGX_CONF_PREFIX"
  nginx configuration file: "$NGX_CONF_PATH"
  nginx pid file: "$NGX_PID_PATH"
END

</span>...

<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$NGX_POST_CONF_MSG</span><span class="s2">"</span>
</code></pre>
</div>
